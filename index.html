<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Penting untuk responsivitas di semua perangkat -->
    <title>Keuangan Bulananku</title>
    <!-- Tailwind CSS CDN untuk styling responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Poppins untuk font yang menarik -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- SheetJS CDN untuk ekspor XLSX -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- jsPDF CDN untuk ekspor PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable CDN untuk membuat tabel di PDF dengan mudah -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
      /* Gaya kustom untuk latar belakang body */
      body {
        background-color: #1f2937; /* Abu-abu gelap untuk latar belakang utama */
        transition: background-color 0.3s ease-in-out; /* Transisi halus */
        font-family: "Poppins", sans-serif; /* Terapkan font Poppins secara global */
      }
      /* Gaya kustom untuk pie chart */
      .pie-chart-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        position: relative;
      }
      canvas {
        max-width: 100%;
        max-height: 100%;
        display: block;
      }
      .chart-legend {
        display: flex;
        flex-wrap: wrap; /* Izinkan wrapping pada layar yang lebih kecil */
        justify-content: center;
        gap: 20px;
        margin-top: 16px;
        font-size: 0.875rem; /* text-sm */
        font-weight: 600;
        color: #d1d5db; /* Teks abu-abu terang untuk legenda */
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .legend-color-box {
        width: 16px;
        height: 16px;
        border-radius: 4px;
      }
      /* Efek hover tombol yang ditingkatkan */
      .w-full.bg-indigo-600,
      .w-full.bg-gray-300,
      .py-3.px-6.rounded-full,
      .py-2.px-5.rounded-full {
        transition: all 0.3s ease-in-out; /* Pastikan semua properti bertransisi */
      }
      .w-full.bg-indigo-600:hover {
        box-shadow: 0 8px 15px rgba(67, 56, 202, 0.3); /* Bayangan lebih dalam saat hover */
      }
      .w-full.bg-gray-300:hover {
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }
      #bottom-nav button {
        transition: all 0.2s ease-in-out; /* Pastikan semua properti bertransisi */
      }
      #bottom-nav button:hover {
        transform: translateY(-5px) scale(1.1); /* Efek mengangkat dan sedikit membesar */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Bayangan halus */
      }
      .py-3.px-6.rounded-full:hover,
      .py-2.px-5.rounded-full:hover {
        transform: translateY(-2px) scale(1.05); /* Sedikit mengangkat dan membesar */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      /* Animasi masuk item daftar */
      .transaction-item {
        opacity: 0;
        transform: translateY(20px);
        animation: slideInFromBottom 0.5s forwards ease-out;
      }
      @keyframes slideInFromBottom {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Sembunyikan ikon kalender default untuk input tanggal dan gayanya */
      input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 0;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        cursor: pointer;
      }
      input[type="date"]::-webkit-inner-spin-button,
      input[type="date"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="date"] {
        -webkit-appearance: none; /* Sembunyikan gaya default */
        appearance: none;
      }
      /* Gaya khusus modal */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(
          0,
          0,
          0,
          0.7
        ); /* Latar belakang gelap semi-transparan */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000; /* Pastikan di atas */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .modal-overlay.show {
        opacity: 1;
        visibility: visible;
      }
      .modal-content {
        background-color: #374151; /* Abu-abu gelap untuk latar belakang modal */
        padding: 2rem;
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); /* Bayangan lebih kuat */
        text-align: center;
        max-width: 400px;
        width: 90%;
        transform: translateY(-20px);
        opacity: 0;
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
      }
      .modal-overlay.show .modal-content {
        transform: translateY(0);
        opacity: 1;
      }
      /* Animasi Kustom yang Lebih Elegan */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes fadeInScaleUp {
        from {
          opacity: 0;
          transform: scale(0.95) translateY(10px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }
      @keyframes fadeInSlideRight {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes fadeInSlideLeft {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes bounceIn {
        0% {
          transform: scale(0.3);
          opacity: 0;
        }
        50% {
          transform: scale(1.05);
          opacity: 1;
        }
        70% {
          transform: scale(0.9);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes slideInUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Apply these to elements */
      .animate-fade-in-up {
        animation: fadeInUp 0.7s ease-out forwards;
      }
      .animate-fade-in-scale-up {
        animation: fadeInScaleUp 0.7s ease-out forwards;
      }
      .animate-fade-in-slide-right {
        animation: fadeInSlideRight 0.6s ease-out forwards;
      }
      .animate-fade-in-slide-left {
        animation: fadeInSlideLeft 0.6s ease-out forwards;
      }
      .animate-bounce-in {
        animation: bounceIn 0.8s ease-out forwards;
      }
      .animate-slide-in-up {
        animation: slideInUp 0.5s ease-out forwards;
      }
      /* Hover effect for logo */
      .logo-animated:hover {
        transform: scale(1.1);
        transition: transform 0.3s ease-in-out;
      }
      .recap-item:nth-child(even) {
        background-color: #374151; /* Warna latar belakang alternatif */
      }
    </style>
  </head>
  <body class="bg-gray-900 font-sans text-gray-200">
    <!-- Kontainer utama aplikasi, responsif dengan padding yang berubah sesuai ukuran layar -->
    <div
      id="app-container"
      class="min-h-screen flex flex-col items-center p-4 sm:p-6 pb-20"
    >
      <!-- Kontainer konten utama, lebar penuh tapi dengan lebar maksimal pada layar besar -->
      <div
        class="w-full max-w-4xl bg-gray-800 rounded-xl shadow-2xl p-6 sm:p-8 space-y-8"
      >
        <!-- Header, menggunakan flexbox untuk menata elemen secara responsif -->
        <div class="flex items-center justify-between mb-4">
          <!-- Teks judul, mengambil ruang yang tersedia -->
          <div class="text-left flex-grow">
            <!-- Judul responsif: lebih kecil di ponsel, membesar di layar sm dan md -->
            <h1
              class="text-3xl sm:text-4xl font-extrabold text-indigo-400 mb-2 animate-fade-in-scale-up"
            >
              KeuanganKu
            </h1>
            <!-- Deskripsi responsif: lebih kecil di ponsel, membesar di layar sm -->
            <p class="text-sm sm:text-lg text-gray-400">
              Kelola keuangan Anda dengan mudah
            </p>
          </div>
          <!-- Logo responsif: lebih kecil di ponsel, membesar di layar sm -->
          <img
            src="iko.png"
            alt="Logo KeuanganKu"
            class="h-16 w-16 sm:h-20 sm:w-20 rounded-full object-cover shadow-lg animate-bounce-in logo-animated"
          />
        </div>
        <!-- Area konten (akan diperbarui secara dinamis oleh JavaScript) -->
        <div id="content-area"></div>
      </div>
      <!-- Footer dengan informasi hak cipta, dikembalikan ke posisi semula -->
      <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>Copyright Â© 2025 by mikopratama</p>
      </footer>
    </div>
    <!-- Bilah Navigasi Bawah, posisi tetap dan responsif di seluruh lebar layar -->
    <div
      id="bottom-nav"
      class="fixed bottom-0 left-0 right-0 bg-gray-700 border-t border-gray-600 shadow-lg p-4 flex justify-around items-center rounded-t-xl z-50"
    >
      <button
        id="nav-home"
        class="flex flex-col items-center p-2 rounded-lg transition duration-200 ease-in-out text-indigo-300 bg-gray-800 animate-slide-in-up"
        style="animation-delay: 0.1s"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          strokeWidth="2"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
          />
        </svg>
        <span class="text-xs mt-1">Beranda</span>
      </button>
      <button
        id="nav-add"
        class="flex flex-col items-center p-2 rounded-lg transition duration-200 ease-in-out text-gray-400 hover:text-indigo-300 animate-slide-in-up"
        style="animation-delay: 0.2s"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          strokeWidth="2"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span class="text-xs mt-1">Tambah</span>
      </button>
      <button
        id="nav-list"
        class="flex flex-col items-center p-2 rounded-lg transition duration-200 ease-in-out text-gray-400 hover:text-indigo-300 animate-slide-in-up"
        style="animation-delay: 0.3s"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          strokeWidth="2"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 002-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
          />
        </svg>
        <span class="text-xs mt-1">Riwayat</span>
      </button>
    </div>
    <!-- Modal Konfirmasi Hapus Kustom (untuk satu item) -->
    <div id="delete-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-xl font-bold text-red-300 mb-4">Konfirmasi Hapus</h3>
        <p class="text-gray-200 mb-6">
          Apakah Anda yakin ingin menghapus transaksi ini?
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="confirm-delete-btn"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out"
          >
            Ya, Hapus
          </button>
          <button
            id="cancel-delete-btn"
            class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out"
          >
            Batal
          </button>
        </div>
      </div>
    </div>
    <!-- Modal Konfirmasi Hapus Semua Riwayat -->
    <div id="delete-all-modal-overlay" class="modal-overlay">
      <div class="modal-content">
        <h3 class="text-xl font-bold text-red-300 mb-4">
          Konfirmasi Hapus Semua
        </h3>
        <p class="text-gray-200 mb-6">
          Apakah Anda yakin ingin menghapus SEMUA riwayat transaksi? Tindakan
          ini tidak dapat dibatalkan.
        </p>
        <div class="flex justify-center space-x-4">
          <button
            id="confirm-delete-all-btn"
            class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out"
          >
            Ya, Hapus Semua
          </button>
          <button
            id="cancel-delete-all-btn"
            class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out"
          >
            Batal
          </button>
        </div>
      </div>
    </div>
    <script>
      // Variabel state global
      let transactions = [];
      let currentScreen = "home";
      let editingTransactionId = null;
      let isExpense = true; // true untuk pengeluaran, false untuk pemasukan
      let viewMode = "monthly"; // 'daily', 'weekly' atau 'monthly'
      let transactionToDeleteId = null; // Untuk menyimpan ID transaksi yang akan dihapus
      let filterType = "all"; // 'all', 'expense', 'income'
      let sortOrder = "monthlyGrouped"; // Mengubah default sort menjadi 'monthlyGrouped'

      // Elemen DOM
      const htmlElement = document.documentElement; // Dapatkan elemen HTML root
      const contentArea = document.getElementById("content-area");
      const navHome = document.getElementById("nav-home");
      const navAdd = document.getElementById("nav-add");
      const navList = document.getElementById("nav-list");
      const navButtons = [navHome, navAdd, navList];

      // Elemen modal
      const deleteModalOverlay = document.getElementById(
        "delete-modal-overlay"
      );
      const confirmDeleteBtn = document.getElementById("confirm-delete-btn");
      const cancelDeleteBtn = document.getElementById("cancel-delete-btn");
      const deleteAllModalOverlay = document.getElementById(
        "delete-all-modal-overlay"
      );
      const confirmDeleteAllBtn = document.getElementById(
        "confirm-delete-all-btn"
      );
      const cancelDeleteAllBtn = document.getElementById(
        "cancel-delete-all-btn"
      );

      // Global variable to store the animation frame ID for pie chart
      let pieChartAnimationFrameId = null;

      // --- Fungsi Utilitas ---
      // Fungsi untuk memformat angka dengan pemisah ribuan (mis. 50000 -> 50.000)
      function formatNumber(num) {
        if (typeof num !== "number") return num; // Return as is if not a number
        return num.toLocaleString("id-ID");
      }

      // Fungsi untuk mengurai angka yang diformat kembali ke angka mentah
      function parseFormattedNumber(str) {
        if (typeof str !== "string") return 0;
        return parseFloat(str.replace(/[^0-9]/g, "")); // Hanya hapus karakter non-digit
      }

      // Fungsi untuk memformat tanggal ke "DD MMMM YYYY" (mis. 28 Juli 2025)
      function formatDateToDisplay(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString + "T00:00:00"); // Add T00:00:00 to avoid timezone issues
        // Check if the date is valid
        if (isNaN(date.getTime())) {
          console.error("Invalid date string:", dateString);
          return "";
        }
        const options = { day: "numeric", month: "long", year: "numeric" };
        return date.toLocaleDateString("id-ID", options);
      }

      // Fungsi untuk mendapatkan tanggal hari ini dalam format YYYY-MM-DD
      function getTodayDateString() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      // Fungsi untuk mendapatkan tanggal awal minggu (hari Minggu) dari tanggal yang diberikan
      function getStartOfWeek(dateString) {
        const date = new Date(dateString + "T00:00:00");
        const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
        const diff = date.getDate() - day;
        const startOfWeek = new Date(date.setDate(diff));
        return startOfWeek.toISOString().split("T")[0]; // Format as YYYY-MM-DD
      }

      // Fungsi untuk mendapatkan tanggal akhir minggu (hari Sabtu) dari tanggal yang diberikan
      function getEndOfWeek(dateString) {
        const date = new Date(dateString + "T00:00:00");
        const day = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
        const diff = date.getDate() - day + 6;
        const endOfWeek = new Date(date.setDate(diff));
        return endOfWeek.toISOString().split("T")[0]; // Format as YYYY-MM-DD
      }

      // Simpan transaksi ke local storage
      function saveTransactionsToLocalStorage() {
        localStorage.setItem("transactions", JSON.stringify(transactions));
      }

      // Muat transaksi dari local storage
      function loadTransactionsFromLocalStorage() {
        const storedTransactions = localStorage.getItem("transactions");
        if (storedTransactions) {
          transactions = JSON.parse(storedTransactions);
        }
      }

      // Bersihkan bidang input dan status pengeditan
      function clearForm() {
        editingTransactionId = null;
        isExpense = true; // Reset ke pengeluaran secara default
      }

      // Tampilkan modal
      function showModal(modalOverlay) {
        modalOverlay.classList.add("show");
      }

      // Sembunyikan modal
      function hideModal(modalOverlay) {
        modalOverlay.classList.remove("show");
      }

      // --- Fungsi Logika Inti ---
      // Hitung ringkasan dan data grafik berdasarkan mode tampilan saat ini
      function calculateSummaryAndChartData() {
        const now = new Date();
        let filtered = [];
        let totalIncome = 0;
        let totalExpense = 0;

        if (viewMode === "daily") {
          const todayDate = getTodayDateString();
          filtered = transactions.filter(
            (transaction) => transaction.date === todayDate
          );
        } else if (viewMode === "weekly") {
          const startOfWeek = new Date(now);
          startOfWeek.setDate(now.getDate() - now.getDay()); // Sunday
          startOfWeek.setHours(0, 0, 0, 0);
          const endOfWeek = new Date(now);
          endOfWeek.setDate(now.getDate() - now.getDay() + 6); // Saturday
          endOfWeek.setHours(23, 59, 59, 999);

          filtered = transactions.filter((transaction) => {
            const transactionDateObj = new Date(transaction.date);
            return (
              transactionDateObj >= startOfWeek &&
              transactionDateObj <= endOfWeek
            );
          });
        } else {
          // Tampilan bulanan
          const currentMonth = now.getMonth();
          const currentYear = now.getFullYear();
          filtered = transactions.filter((transaction) => {
            const transactionDateObj = new Date(transaction.date);
            return (
              transactionDateObj.getMonth() === currentMonth &&
              transactionDateObj.getFullYear() === currentYear
            );
          });
        }

        filtered.forEach((transaction) => {
          if (transaction.type === "expense") {
            totalExpense += transaction.amount; // Akumulasi pengeluaran
          } else {
            totalIncome += transaction.amount; // Akumulasi pemasukan
          }
        });

        const totalAmount = totalIncome - totalExpense; // Saldo bersih

        return {
          filteredTransactions: filtered,
          totalAmount: totalAmount,
          totalIncome: totalIncome,
          totalExpense: totalExpense,
        };
      }

      // Tambah atau perbarui transaksi
      function saveTransaction() {
        const nameInput = document.getElementById("transaction-name");
        const amountInput = document.getElementById("transaction-amount");
        const dateHiddenInput = document.getElementById(
          "transaction-date-hidden"
        );

        const name = nameInput.value.trim();
        const amount = parseFormattedNumber(amountInput.value);
        const date = dateHiddenInput.value; // YYYY-MM-DD

        if (!name || amount <= 0 || !date) {
          showCustomAlert("Harap isi semua bidang dengan benar.");
          return;
        }

        const newTransaction = {
          id: editingTransactionId || Date.now().toString(), // Gunakan ID yang ada atau buat yang baru
          name: name,
          amount: amount,
          date: date,
          type: isExpense ? "expense" : "income",
        };

        if (editingTransactionId) {
          // Perbarui transaksi yang sudah ada
          const index = transactions.findIndex(
            (t) => t.id === editingTransactionId
          );
          if (index !== -1) {
            transactions[index] = newTransaction;
          }
        } else {
          // Tambah transaksi baru
          transactions.push(newTransaction);
        }

        saveTransactionsToLocalStorage();
        clearForm(); // Reset form state
        currentScreen = "list"; // Redirect ke daftar setelah menyimpan
        updateUI();
      }

      // Hapus transaksi individu
      function deleteTransaction(id) {
        transactions = transactions.filter((t) => t.id !== id);
        saveTransactionsToLocalStorage();
        updateUI();
        hideModal(deleteModalOverlay);
      }

      // Hapus semua transaksi
      function deleteAllTransactions() {
        transactions = [];
        saveTransactionsToLocalStorage();
        updateUI();
        hideModal(deleteAllModalOverlay);
      }

      // Fungsi untuk mengelompokkan transaksi berdasarkan bulan
      function groupTransactionsByMonth(transactionsToGroup) {
        return transactionsToGroup.reduce((acc, transaction) => {
          const monthKey = transaction.date.substring(0, 7); // e.g., '2025-07'
          if (!acc[monthKey]) {
            acc[monthKey] = [];
          }
          acc[monthKey].push(transaction);
          return acc;
        }, {});
      }

      // Fungsi untuk mengelompokkan transaksi berdasarkan hari
      function groupTransactionsByDay(transactionsToGroup) {
        return transactionsToGroup.reduce((acc, transaction) => {
          const dayKey = transaction.date; // e.g., '2025-07-28'
          if (!acc[dayKey]) {
            acc[dayKey] = [];
          }
          acc[dayKey].push(transaction);
          return acc;
        }, {});
      }

      // --- Fungsi Render untuk Setiap Layar ---
      function renderHomeScreen() {
        const { totalAmount, totalIncome, totalExpense } =
          calculateSummaryAndChartData();
        contentArea.innerHTML = `
                <div class="flex flex-wrap justify-center gap-2 mb-6 animate-fade-in-up">
                    <button id="view-daily" class="flex-1 min-w-[100px] py-3 px-2 sm:px-6 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out ${
                      viewMode === "daily"
                        ? "bg-purple-600 text-white shadow-md"
                        : "bg-gray-600 text-gray-200 hover:bg-gray-500"
                    }">
                        Harian
                    </button>
                    <button id="view-weekly" class="flex-1 min-w-[100px] py-3 px-2 sm:px-6 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out ${
                      viewMode === "weekly"
                        ? "bg-purple-600 text-white shadow-md"
                        : "bg-gray-600 text-gray-200 hover:bg-gray-500"
                    }">
                        Mingguan
                    </button>
                    <button id="view-monthly" class="flex-1 min-w-[100px] py-3 px-2 sm:px-6 rounded-full font-semibold text-sm sm:text-base transition duration-300 ease-in-out ${
                      viewMode === "monthly"
                        ? "bg-purple-600 text-white shadow-md"
                        : "bg-gray-600 text-gray-200 hover:bg-gray-500"
                    }">
                        Bulanan
                    </button>
                </div>
                <div class="bg-gray-700 p-6 rounded-xl shadow-inner space-y-6 animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-purple-300 text-center">
                        Ringkasan ${
                          viewMode === "daily"
                            ? "Harian"
                            : viewMode === "weekly"
                            ? "Mingguan"
                            : "Bulanan"
                        }
                    </h2>
                    
                    <!-- Tata Letak Ringkasan yang Lebih Baik dan Responsif dengan Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <div class="bg-gray-800 p-4 rounded-lg text-center shadow-md animate-fade-in-up">
                            <p class="text-base sm:text-lg md:text-lg font-semibold text-green-400">Pemasukan:</p>
                            <p class="text-lg sm:text-xl md:text-2xl font-bold text-green-300">Rp${formatNumber(
                              totalIncome
                            )}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center shadow-md animate-fade-in-up">
                            <p class="text-base sm:text-lg md:text-lg font-semibold text-red-400">Pengeluaran:</p>
                            <p class="text-lg sm:text-xl md:text-2xl font-bold text-red-300">Rp${formatNumber(
                              totalExpense
                            )}</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg text-center shadow-md ${
                          totalAmount >= 0 ? "text-blue-400" : "text-red-400"
                        } animate-fade-in-up">
                            <p class="text-base sm:text-lg md:text-lg font-semibold">Sisa Saldo:</p>
                            <p class="text-xl sm:text-2xl md:text-3xl font-extrabold">Rp${formatNumber(
                              totalAmount
                            )}</p>
                        </div>
                    </div>
                    <div class="h-80 sm:h-96 bg-gray-800 rounded-lg p-4 shadow-md flex flex-col items-center justify-center animate-fade-in-up">
                        <div class="pie-chart-container w-full h-full max-w-xs max-h-xs sm:max-w-sm sm:max-h-sm">
                            <canvas id="pie-chart"></canvas>
                        </div>
                        <div class="chart-legend mt-4 text-gray-200">
                            <div class="legend-item">
                                <div class="legend-color-box bg-green-500"></div>
                                <span>Pemasukan</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color-box bg-red-500"></div>
                                <span>Pengeluaran</span>
                            </div>
                        </div>
                        <div id="pie-percentages" class="text-center text-sm font-bold mt-2 space-y-1">
                            <!-- Persentase akan dirender di sini -->
                        </div>
                    </div>
                </div>
            `;
        document.getElementById("view-daily").addEventListener("click", () => {
          viewMode = "daily";
          updateUI();
        });
        document.getElementById("view-weekly").addEventListener("click", () => {
          viewMode = "weekly";
          updateUI();
        });
        document
          .getElementById("view-monthly")
          .addEventListener("click", () => {
            viewMode = "monthly";
            updateUI();
          });
        renderPieChart(totalIncome, totalExpense);
      }

      function renderPieChart(income, expense) {
        const canvas = document.getElementById("pie-chart");
        const percentagesDiv = document.getElementById("pie-percentages");
        if (!canvas || !percentagesDiv) return;

        const ctx = canvas.getContext("2d");
        const total = income + expense;
        const dpi = window.devicePixelRatio || 1;

        // Get the computed style for width and height
        const style_height_px = parseFloat(
          getComputedStyle(canvas).getPropertyValue("height")
        );
        const style_width_px = parseFloat(
          getComputedStyle(canvas).getPropertyValue("width")
        );

        // Set the canvas dimensions to match the CSS dimensions, scaled by DPI
        canvas.width = style_width_px * dpi;
        canvas.height = style_height_px * dpi;

        // Scale the context to ensure drawing is clear on high-DPI screens
        ctx.scale(dpi, dpi);

        // Calculate center and radius based on the *actual* displayed size (style_width_px, style_height_px)
        const centerX = style_width_px / 2;
        const centerY = style_height_px / 2;
        const radius = Math.min(centerX, centerY) * 0.8; // Use 0.8 to leave some padding

        // Clear any existing animation frame
        if (pieChartAnimationFrameId) {
          cancelAnimationFrame(pieChartAnimationFrameId);
        }

        let startTime = null;
        const animationDuration = 1000; // 1 second for the animation

        function animatePie(currentTime) {
          if (!startTime) startTime = currentTime;
          const progress = (currentTime - startTime) / animationDuration;

          ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear canvas for each frame

          let currentAngle = 0;
          const incomeColor = "#10B981"; // Tailwind green-600
          const expenseColor = "#EF4444"; // Tailwind red-600

          // Draw Income slice
          if (income > 0) {
            const incomeSliceAngle = (income / total) * 2 * Math.PI;
            const animatedIncomeAngle =
              incomeSliceAngle * Math.min(progress, 1);
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(
              centerX,
              centerY,
              radius,
              currentAngle,
              currentAngle + animatedIncomeAngle
            );
            ctx.closePath();
            ctx.fillStyle = incomeColor;
            ctx.fill();
            currentAngle += animatedIncomeAngle;
          }

          // Draw Expense slice
          if (expense > 0) {
            const expenseSliceAngle = (expense / total) * 2 * Math.PI;
            const animatedExpenseAngle =
              expenseSliceAngle * Math.min(progress, 1);
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(
              centerX,
              centerY,
              radius,
              currentAngle,
              currentAngle + animatedExpenseAngle
            );
            ctx.closePath();
            ctx.fillStyle = expenseColor;
            ctx.fill();
            currentAngle += animatedExpenseAngle;
          }

          // Draw the inner circle for donut effect
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius * 0.6, 0, 2 * Math.PI);
          ctx.fillStyle = "#374151"; // Background color of the main content area (gray-700)
          ctx.fill();

          // Update percentages only at the end of the animation or if no animation
          if (progress >= 1) {
            percentagesDiv.innerHTML = "";
            if (income === 0 && expense === 0) {
              percentagesDiv.innerHTML = `<p class="text-gray-400 italic">Tidak ada data</p>`;
            } else if (income > 0 && expense === 0) {
              percentagesDiv.innerHTML = `<p class="text-green-400">100% Pemasukan</p>`;
            } else if (income === 0 && expense > 0) {
              percentagesDiv.innerHTML = `<p class="text-red-400">100% Pengeluaran</p>`;
            } else {
              const incomePercentage = ((income / total) * 100).toFixed(1);
              const expensePercentage = ((expense / total) * 100).toFixed(1);
              percentagesDiv.innerHTML = `
                        <p class="text-green-400">${incomePercentage}% Pemasukan</p>
                        <p class="text-red-400">${expensePercentage}% Pengeluaran</p>
                    `;
            }
          }

          if (progress < 1) {
            pieChartAnimationFrameId = requestAnimationFrame(animatePie);
          }
        }
        pieChartAnimationFrameId = requestAnimationFrame(animatePie);
      }

      function renderAddScreen() {
        const transactionToEdit = editingTransactionId
          ? transactions.find((t) => t.id === editingTransactionId)
          : null;
        contentArea.innerHTML = `
                <div class="bg-gray-700 p-6 rounded-lg shadow-inner space-y-4 animate-fade-in-up">
                    <!-- Judul layar tambah transaksi, sekarang di tengah -->
                    <h2 class="text-2xl font-bold text-indigo-300 mb-4 text-center">
                        ${
                          editingTransactionId
                            ? "Edit Transaksi"
                            : "Tambah Transaksi Baru"
                        }
                    </h2>
                    <!-- Tombol Pengeluaran/Pemasukan yang responsif -->
                    <div class="flex justify-center space-x-4 mb-4 w-full animate-fade-in-up">
                        <button id="toggle-expense" class="flex-1 py-2 rounded-full font-semibold transition duration-300 ease-in-out ${
                          isExpense
                            ? "bg-red-600 text-white shadow-md"
                            : "bg-gray-600 text-gray-200 hover:bg-gray-500"
                        }">
                            Pengeluaran
                        </button>
                        <button id="toggle-income" class="flex-1 py-2 rounded-full font-semibold transition duration-300 ease-in-out ${
                          !isExpense
                            ? "bg-green-600 text-white shadow-md"
                            : "bg-gray-600 text-gray-200 hover:bg-gray-500"
                        }">
                            Pemasukan
                        </button>
                    </div>
                    <input type="text" id="transaction-name" placeholder="Nama Transaksi (mis. Kopi, Gaji)"
                        class="w-full p-3 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out bg-gray-800 text-gray-200 animate-fade-in-up"
                        value="${
                          transactionToEdit ? transactionToEdit.name : ""
                        }" />
                    <input type="text" id="transaction-amount" placeholder="Jumlah (mis. 50.000)"
                        class="w-full p-3 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out bg-gray-800 text-gray-200 animate-fade-in-up"
                        inputmode="numeric" value="${
                          transactionToEdit
                            ? formatNumber(transactionToEdit.amount)
                            : ""
                        }" />
                    <div class="relative animate-fade-in-up">
                        <!-- Input teks yang terlihat untuk tanggal yang diformat -->
                        <input type="text" id="transaction-date-display" placeholder="Tanggal (mis. 28 Juli 2025)"
                            class="w-full p-3 border border-gray-600 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out bg-gray-800 text-gray-200 pr-10"
                            value="${
                              transactionToEdit
                                ? formatDateToDisplay(transactionToEdit.date)
                                : formatDateToDisplay(getTodayDateString()) // Set default display date
                            }" readonly />
                        <!-- Input tanggal tersembunyi untuk memicu pemilih asli -->
                        <input type="date" id="transaction-date-hidden"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                            value="${
                              transactionToEdit
                                ? transactionToEdit.date
                                : getTodayDateString()
                            }" />
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <!-- Ikon Kalender SVG Kustom -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                        </div>
                    </div>
                    <button id="add-transaction-btn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition duration-200 ease-in-out animate-fade-in-up">
                        ${
                          editingTransactionId
                            ? "Perbarui Transaksi"
                            : "Tambah Transaksi"
                        }
                    </button>
                    ${
                      editingTransactionId
                        ? `<button id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-3 rounded-lg shadow-md transition duration-200 ease-in-out mt-2 animate-fade-in-up">Batal</button>`
                        : ""
                    }
                </div>
            `;
        // Attach event listeners after rendering
        document
          .getElementById("toggle-expense")
          .addEventListener("click", () => {
            isExpense = true;
            renderAddScreen(); // Re-render to update button styles
          });
        document
          .getElementById("toggle-income")
          .addEventListener("click", () => {
            isExpense = false;
            renderAddScreen(); // Re-render to update button styles
          });

        const transactionAmountInput =
          document.getElementById("transaction-amount");
        transactionAmountInput.addEventListener("input", function (e) {
          const rawValue = this.value.replace(/[^0-9]/g, ""); // Remove non-digits
          this.value = formatNumber(parseInt(rawValue || 0));
        });

        const transactionDateDisplay = document.getElementById(
          "transaction-date-display"
        );
        const transactionDateHidden = document.getElementById(
          "transaction-date-hidden"
        );

        // Update display input when hidden date input changes
        transactionDateHidden.addEventListener("change", (e) => {
          transactionDateDisplay.value = formatDateToDisplay(e.target.value);
        });

        document
          .getElementById("add-transaction-btn")
          .addEventListener("click", saveTransaction);

        if (editingTransactionId) {
          document
            .getElementById("cancel-edit-btn")
            .addEventListener("click", () => {
              editingTransactionId = null;
              currentScreen = "list";
              updateUI();
            });
        }
      }

      function renderListScreen() {
        // Filter and sort transactions
        let displayedTransactions = [...transactions]; // Create a copy to sort/filter without modifying original

        if (filterType !== "all") {
          displayedTransactions = displayedTransactions.filter(
            (t) => t.type === filterType
          );
        }

        let listHtml = "";

        if (displayedTransactions.length === 0) {
          listHtml =
            '<p class="text-center text-gray-400 italic">Tidak ada transaksi.</p>';
        } else if (sortOrder === "monthlyGrouped") {
          // Group and sort by month first
          const groupedByMonth = displayedTransactions.reduce(
            (acc, transaction) => {
              const monthKey = transaction.date.substring(0, 7); // e.g., '2025-07'
              if (!acc[monthKey]) {
                acc[monthKey] = [];
              }
              acc[monthKey].push(transaction);
              return acc;
            },
            {}
          );

          // Sort month keys from newest to oldest
          const sortedMonthKeys = Object.keys(groupedByMonth).sort((a, b) =>
            b.localeCompare(a)
          );

          // Loop through the sorted month groups
          listHtml = sortedMonthKeys
            .map((monthKey) => {
              // Format month header (e.g., 'Juli 2025')
              const headerDate = new Date(monthKey + "-01");
              const headerText = headerDate.toLocaleDateString("id-ID", {
                month: "long",
                year: "numeric",
              });

              // Sort transactions within each month group by date (newest first)
              const transactionsInMonth = groupedByMonth[monthKey].sort(
                (a, b) => new Date(b.date) - new Date(a.date)
              );

              // Generate HTML for each transaction in the group
              const transactionItemsHtml = transactionsInMonth
                .map(
                  (t, index) => `
                    <div class="transaction-item bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between animate-fade-in-slide-right" style="animation-delay: ${
                      index * 0.05
                    }s;">
                        <div class="flex-grow">
                            <p class="text-lg font-semibold ${
                              t.type === "expense"
                                ? "text-red-300"
                                : "text-green-300"
                            }">${t.name}</p>
                            <p class="text-sm text-gray-400">Rp${formatNumber(
                              t.amount
                            )} - ${formatDateToDisplay(t.date)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${
                              t.id
                            }" class="edit-btn text-blue-400 hover:text-blue-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button data-id="${
                              t.id
                            }" class="delete-btn text-red-400 hover:text-red-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            </button>
                        </div>
                    </div>
                `
                )
                .join("");

              return `
                    <div class="monthly-group">
                        <h3 class="text-xl font-bold text-indigo-300 mt-4 mb-2">${headerText}</h3>
                        <div class="space-y-3">
                            ${transactionItemsHtml}
                        </div>
                    </div>
                `;
            })
            .join("");
        } else if (sortOrder === "weeklyGrouped") {
          const groupedByWeek = displayedTransactions.reduce(
            (acc, transaction) => {
              const weekKey = getStartOfWeek(transaction.date);
              if (!acc[weekKey]) {
                acc[weekKey] = [];
              }
              acc[weekKey].push(transaction);
              return acc;
            },
            {}
          );

          const sortedWeekKeys = Object.keys(groupedByWeek).sort((a, b) =>
            b.localeCompare(a)
          );

          listHtml = sortedWeekKeys
            .map((weekKey) => {
              const startOfWeek = formatDateToDisplay(weekKey);
              const endOfWeek = formatDateToDisplay(getEndOfWeek(weekKey));
              const headerText = `Minggu: ${startOfWeek} - ${endOfWeek}`;

              const transactionsInWeek = groupedByWeek[weekKey].sort(
                (a, b) => new Date(b.date) - new Date(a.date)
              );

              const transactionItemsHtml = transactionsInWeek
                .map(
                  (t, index) => `
                    <div class="transaction-item bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between animate-fade-in-slide-right" style="animation-delay: ${
                      index * 0.05
                    }s;">
                        <div class="flex-grow">
                            <p class="text-lg font-semibold ${
                              t.type === "expense"
                                ? "text-red-300"
                                : "text-green-300"
                            }">${t.name}</p>
                            <p class="text-sm text-gray-400">Rp${formatNumber(
                              t.amount
                            )} - ${formatDateToDisplay(t.date)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${
                              t.id
                            }" class="edit-btn text-blue-400 hover:text-blue-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button data-id="${
                              t.id
                            }" class="delete-btn text-red-400 hover:text-red-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            </button>
                        </div>
                    </div>
                `
                )
                .join("");

              return `
                    <div class="weekly-group">
                        <h3 class="text-xl font-bold text-indigo-300 mt-4 mb-2">${headerText}</h3>
                        <div class="space-y-3">
                            ${transactionItemsHtml}
                        </div>
                    </div>
                `;
            })
            .join("");
        } else if (sortOrder === "dailyGrouped") {
          const groupedByDay = displayedTransactions.reduce(
            (acc, transaction) => {
              const dayKey = transaction.date; // e.g., '2025-07-28'
              if (!acc[dayKey]) {
                acc[dayKey] = [];
              }
              acc[dayKey].push(transaction);
              return acc;
            },
            {}
          );

          const sortedDayKeys = Object.keys(groupedByDay).sort((a, b) =>
            b.localeCompare(a)
          ); // Newest day first

          listHtml = sortedDayKeys
            .map((dayKey) => {
              const headerText = formatDateToDisplay(dayKey);
              const transactionsInDay = groupedByDay[dayKey].sort(
                (a, b) => new Date(b.date) - new Date(a.date)
              ); // Sort by time if needed, currently by date

              const transactionItemsHtml = transactionsInDay
                .map(
                  (t, index) => `
                    <div class="transaction-item bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between animate-fade-in-slide-right" style="animation-delay: ${
                      index * 0.05
                    }s;">
                        <div class="flex-grow">
                            <p class="text-lg font-semibold ${
                              t.type === "expense"
                                ? "text-red-300"
                                : "text-green-300"
                            }">${t.name}</p>
                            <p class="text-sm text-gray-400">Rp${formatNumber(
                              t.amount
                            )} - ${formatDateToDisplay(t.date)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-id="${
                              t.id
                            }" class="edit-btn text-blue-400 hover:text-blue-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button data-id="${
                              t.id
                            }" class="delete-btn text-red-400 hover:text-red-300 p-1 rounded-full transition duration-150 ease-in-out">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `
                )
                .join("");

              return `
                    <div class="daily-group">
                        <h3 class="text-xl font-bold text-indigo-300 mt-4 mb-2">${headerText}</h3>
                        <div class="space-y-3">
                            ${transactionItemsHtml}
                        </div>
                    </div>
                `;
            })
            .join("");
        } else {
          // Sorting untuk oldest, amount-desc, amount-asc (flat list)
          if (sortOrder === "oldest") {
            displayedTransactions.sort(
              (a, b) => new Date(a.date) - new Date(b.date)
            );
          } else if (sortOrder === "amount-desc") {
            displayedTransactions.sort((a, b) => b.amount - a.amount);
          } else if (sortOrder === "amount-asc") {
            displayedTransactions.sort((a, b) => a.amount - b.amount);
          }

          listHtml = displayedTransactions
            .map(
              (t, index) => `
                <div class="transaction-item bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between animate-fade-in-slide-right" style="animation-delay: ${
                  index * 0.05
                }s;">
                    <div class="flex-grow">
                        <p class="text-lg font-semibold ${
                          t.type === "expense"
                            ? "text-red-300"
                            : "text-green-300"
                        }">${t.name}</p>
                        <p class="text-sm text-gray-400">Rp${formatNumber(
                          t.amount
                        )} - ${formatDateToDisplay(t.date)}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button data-id="${
                          t.id
                        }" class="edit-btn text-blue-400 hover:text-blue-300 p-1 rounded-full transition duration-150 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button data-id="${
                          t.id
                        }" class="delete-btn text-red-400 hover:text-red-300 p-1 rounded-full transition duration-150 ease-in-out">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `
            )
            .join("");
        }

        contentArea.innerHTML = `
                <div class="bg-gray-700 p-6 rounded-xl shadow-inner space-y-6 animate-fade-in-up">
                    <h2 class="text-2xl font-bold text-indigo-300 text-center mb-4">Riwayat Transaksi</h2>
                    <!-- Filter, Opsi Urutkan, dan Tombol Rekap/Ekspor (Layout Responsif Baru) -->
                    <div class="flex flex-col sm:flex-row sm:flex-wrap justify-center gap-2 sm:gap-4 mb-6">
                        <!-- Dropdown Filter dan Sortir -->
                        <select id="filter-type" class="w-full sm:w-auto p-2 rounded-md bg-gray-800 text-gray-200 border border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            <option value="all" ${
                              filterType === "all" ? "selected" : ""
                            }>Semua</option>
                            <option value="income" ${
                              filterType === "income" ? "selected" : ""
                            }>Pemasukan</option>
                            <option value="expense" ${
                              filterType === "expense" ? "selected" : ""
                            }>Pengeluaran</option>
                        </select>
                        <select id="sort-order" class="w-full sm:w-auto p-2 rounded-md bg-gray-800 text-gray-200 border border-gray-600 focus:ring-2 focus:ring-indigo-500">
                            <option value="monthlyGrouped" ${
                              sortOrder === "monthlyGrouped" ? "selected" : ""
                            }>Bulanan</option>
                            <option value="weeklyGrouped" ${
                              sortOrder === "weeklyGrouped" ? "selected" : ""
                            }>Mingguan</option>
                            <option value="dailyGrouped" ${
                              sortOrder === "dailyGrouped" ? "selected" : ""
                            }>Harian</option>
                            <option value="oldest" ${
                              sortOrder === "oldest" ? "selected" : ""
                            }>Terlama</option>
                            <option value="amount-desc" ${
                              sortOrder === "amount-desc" ? "selected" : ""
                            }>Jumlah (Terbesar)</option>
                            <option value="amount-asc" ${
                              sortOrder === "amount-asc" ? "selected" : ""
                            }>Jumlah (Terkecil)</option>
                        </select>
                        <!-- Tombol Aksi -->
                        <div class="flex w-full sm:w-auto space-x-2 sm:space-x-4 mt-2 sm:mt-0">
                          <button id="export-pdf-btn" class="flex-1 py-1 px-3 bg-red-600 hover:bg-red-700 text-white text-sm rounded-md font-semibold transition duration-200 ease-in-out">
                              Ekspor PDF
                          </button>
                          <button id="export-excel-btn" class="flex-1 py-1 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md font-semibold transition duration-200 ease-in-out">
                              Ekspor XLSX
                          </button>
                        </div>
                    </div>
                    <div id="transactions-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                        ${listHtml}
                    </div>
                    <div class="flex justify-center mt-6">
                        <button id="delete-all-btn" class="py-2 px-5 bg-red-700 hover:bg-red-800 text-white rounded-lg font-semibold shadow-md transition duration-200 ease-in-out animate-fade-in-up">
                            Hapus Semua Riwayat
                        </button>
                    </div>
                </div>
            `;
        // Attach event listeners for filter and sort
        document
          .getElementById("filter-type")
          .addEventListener("change", (e) => {
            filterType = e.target.value;
            updateUI();
          });
        document
          .getElementById("sort-order")
          .addEventListener("change", (e) => {
            sortOrder = e.target.value;
            updateUI();
          });

        // Attach event listeners for edit and delete buttons
        document.querySelectorAll(".edit-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            editingTransactionId = e.currentTarget.dataset.id;
            currentScreen = "add"; // Switch to add screen for editing
            updateUI();
          });
        });

        document.querySelectorAll(".delete-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            transactionToDeleteId = e.currentTarget.dataset.id;
            showModal(deleteModalOverlay);
          });
        });

        document
          .getElementById("delete-all-btn")
          .addEventListener("click", () => {
            showModal(deleteAllModalOverlay);
          });

        // Event listener untuk tombol ekspor PDF
        document
          .getElementById("export-pdf-btn")
          .addEventListener("click", exportToPdf);
        document
          .getElementById("export-excel-btn")
          .addEventListener("click", exportToExcel);
      }

      function exportToExcel() {
        if (transactions.length === 0) {
          showCustomAlert("Tidak ada data untuk diekspor!");
          return;
        }

        const data = transactions.map((t) => ({
          Tanggal: formatDateToDisplay(t.date),
          Nama: t.name,
          Jumlah: t.amount,
          Tipe: t.type === "expense" ? "Pengeluaran" : "Pemasukan",
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Transaksi Keuangan");
        XLSX.writeFile(wb, "keuangan_bulananku.xlsx");
      }

      // Fungsi untuk ekspor ke PDF
      function exportToPdf() {
        if (transactions.length === 0) {
          showCustomAlert("Tidak ada data untuk diekspor!");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Judul
        doc.setFontSize(22);
        doc.text("Rekap Transaksi Keuangan", 14, 20);

        // Sub-judul dan tanggal ekspor
        doc.setFontSize(12);
        doc.setTextColor(100);
        doc.text(
          `Diekspor pada: ${formatDateToDisplay(getTodayDateString())}`,
          14,
          28
        );

        let y = 40;
        doc.setFontSize(16);
        doc.setTextColor(0);

        // Group transactions by month
        const groupedByMonth = groupTransactionsByMonth(transactions);
        const sortedMonthKeys = Object.keys(groupedByMonth).sort((a, b) =>
          b.localeCompare(a)
        );

        sortedMonthKeys.forEach((monthKey) => {
          const monthName = new Date(monthKey + "-01").toLocaleDateString(
            "id-ID",
            { month: "long", year: "numeric" }
          );
          const transactionsInMonth = groupedByMonth[monthKey].sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          // Calculate monthly summary
          let totalIncome = 0;
          let totalExpense = 0;
          transactionsInMonth.forEach((t) => {
            if (t.type === "income") totalIncome += t.amount;
            else totalExpense += t.amount;
          });
          const balance = totalIncome - totalExpense;

          // Add monthly header
          doc.text(`${monthName} - Saldo: Rp${formatNumber(balance)}`, 14, y);
          y += 8;

          const tableData = transactionsInMonth.map((t) => [
            formatDateToDisplay(t.date),
            t.name,
            `Rp${formatNumber(t.amount)}`,
            t.type === "expense" ? "Pengeluaran" : "Pemasukan",
          ]);

          doc.autoTable({
            startY: y,
            head: [["Tanggal", "Nama Transaksi", "Jumlah", "Tipe"]],
            body: tableData,
            theme: "striped",
            styles: {
              font: "helvetica",
              fontSize: 10,
              cellPadding: 3,
              halign: "left",
              valign: "middle",
            },
            headStyles: {
              fillColor: [67, 56, 202], // Indigo-600
              textColor: 255,
              fontStyle: "bold",
            },
            alternateRowStyles: {
              fillColor: [43, 49, 61], // Gray-800
              textColor: [209, 213, 219], // Gray-300
            },
            bodyStyles: {
              fillColor: [55, 65, 81], // Gray-700
              textColor: [229, 231, 235], // Gray-200
            },
          });
          y = doc.autoTable.previous.finalY + 10;
        });

        doc.save("rekap_keuangan_bulanan.pdf");
      }

      // Tampilkan custom alert modal (sebagai pengganti alert bawaan)
      function showCustomAlert(message) {
        const modalHtml = `
              <div id="custom-alert-modal" class="modal-overlay show">
                  <div class="modal-content">
                      <h3 class="text-xl font-bold text-yellow-300 mb-4">Peringatan</h3>
                      <p class="text-gray-200 mb-6">${message}</p>
                      <button id="close-alert-btn" class="bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold py-2 px-5 rounded-lg shadow-md transition duration-200 ease-in-out">Tutup</button>
                  </div>
              </div>
          `;
        document.body.insertAdjacentHTML("beforeend", modalHtml);
        document
          .getElementById("close-alert-btn")
          .addEventListener("click", () => {
            const modal = document.getElementById("custom-alert-modal");
            if (modal) {
              modal.remove();
            }
          });
      }

      // --- Fungsi Pengelolaan UI Global ---
      function updateUI() {
        // Hapus kelas 'active' dari semua tombol navigasi
        navButtons.forEach((button) => {
          button.classList.remove("text-indigo-300", "bg-gray-800");
          button.classList.add("text-gray-400", "hover:text-indigo-300");
        });

        // Tambahkan kelas 'active' ke tombol navigasi yang sedang aktif
        if (currentScreen === "home") {
          navHome.classList.remove("text-gray-400", "hover:text-indigo-300");
          navHome.classList.add("text-indigo-300", "bg-gray-800");
          renderHomeScreen();
        } else if (currentScreen === "add") {
          navAdd.classList.remove("text-gray-400", "hover:text-indigo-300");
          navAdd.classList.add("text-indigo-300", "bg-gray-800");
          renderAddScreen();
        } else if (currentScreen === "list") {
          navList.classList.remove("text-gray-400", "hover:text-indigo-300");
          navList.classList.add("text-indigo-300", "bg-gray-800");
          renderListScreen();
        }
      }

      // --- Event Listeners Global ---
      navHome.addEventListener("click", () => {
        currentScreen = "home";
        updateUI();
      });

      navAdd.addEventListener("click", () => {
        currentScreen = "add";
        clearForm(); // Reset form saat beralih ke layar tambah
        updateUI();
      });

      navList.addEventListener("click", () => {
        currentScreen = "list";
        updateUI();
      });

      // Event listeners untuk modal konfirmasi hapus individu
      confirmDeleteBtn.addEventListener("click", () => {
        if (transactionToDeleteId) {
          deleteTransaction(transactionToDeleteId);
          transactionToDeleteId = null; // Reset
        }
      });

      cancelDeleteBtn.addEventListener("click", () => {
        transactionToDeleteId = null; // Reset
        hideModal(deleteModalOverlay);
      });

      // Event listeners untuk modal konfirmasi hapus semua
      confirmDeleteAllBtn.addEventListener("click", deleteAllTransactions);
      cancelDeleteAllBtn.addEventListener("click", () => {
        hideModal(deleteAllModalOverlay);
      });

      // Inisialisasi aplikasi
      document.addEventListener("DOMContentLoaded", () => {
        loadTransactionsFromLocalStorage();
        updateUI(); // Render layar beranda saat aplikasi dimuat
      });

      // Handle window resize for pie chart responsiveness
      window.addEventListener("resize", () => {
        if (currentScreen === "home") {
          // Re-render the home screen to redraw the pie chart with new dimensions
          renderHomeScreen();
        }
      });
    </script>
  </body>
</html>
